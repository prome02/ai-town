# AI-Town æ”¹é€²è¨ˆåŠƒ - éšæ®µä¸€ï¼šåæ€æ©Ÿåˆ¶ç´°åŒ–

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°
**ç›®æ¨™**ï¼šæ”¹é€²åæ€è§¸ç™¼æ¢ä»¶å’Œæ·±åº¦ï¼Œå¢å¼·æ™ºèƒ½é«”å­¸ç¿’èƒ½åŠ›
**æ ¸å¿ƒæ”¹é€²**ï¼šç´°åŒ– [`convex/agent/memory.ts`](convex/agent/memory.ts:339) ä¸­çš„åæ€é‚è¼¯
**æŠ€è¡“é‡é»**ï¼šå¤šå±¤æ¬¡åæ€æ©Ÿåˆ¶å’Œåæ€è³ªé‡è©•ä¼°

## ğŸ—ï¸ è¨­è¨ˆç†å¿µèˆ‡é‚è¼¯

### è¨­è¨ˆç†å¿µ
æ¡ç”¨ã€Œæ¨¹ç‹€åæ€çµæ§‹ã€ï¼Œå¾åŸºç¤è§€å¯Ÿåˆ°æŠ½è±¡æ¨è«–ï¼Œå€Ÿé‘‘ Generative Agents ç ”ç©¶å ±å‘Šçš„ä¸‰å±¤æ¶æ§‹ï¼š
- **æ·ºå±¤åæ€**ï¼šæ—¥å¸¸äº‹ä»¶ç¸½çµï¼Œè§¸ç™¼é »ç‡é«˜
- **æ·±å±¤åæ€**ï¼šè¡Œç‚ºæ¨¡å¼åˆ†æï¼Œéœ€è¦ç´¯ç©è¶³å¤ äº‹ä»¶
- **æˆ°ç•¥åæ€**ï¼šé•·æœŸç›®æ¨™èª¿æ•´ï¼ŒåŸºæ–¼ç›®æ¨™é€²å±•è©•ä¼°

### æ ¸å¿ƒé‚è¼¯æµç¨‹
```mermaid
graph TD
    A[äº‹ä»¶ç™¼ç”Ÿ] --> B{æª¢æŸ¥åæ€è§¸ç™¼æ¢ä»¶}
    B -->|ç¬¦åˆæ·ºå±¤æ¢ä»¶| C[åŸ·è¡Œæ·ºå±¤åæ€]
    B -->|ç¬¦åˆæ·±å±¤æ¢ä»¶| D[åŸ·è¡Œæ·±å±¤åæ€]
    B -->|ç¬¦åˆæˆ°ç•¥æ¢ä»¶| E[åŸ·è¡Œæˆ°ç•¥åæ€]
    C --> F[æ›´æ–°æ—¥å¸¸è¨˜æ†¶]
    D --> G[æ›´æ–°è¡Œç‚ºæ¨¡å¼]
    E --> H[èª¿æ•´é•·æœŸç›®æ¨™]
```

## ğŸ”§ æŠ€è¡“å¯¦ç¾æ–¹æ¡ˆ

### 1. æ”¹é€²åæ€è§¸ç™¼æ¢ä»¶
```typescript
// æ›´ç´°ç·»çš„åæ€è§¸ç™¼é‚è¼¯
const shouldReflect = (memories: Memory[], now: number): ReflectionType => {
  const recentMemories = memories.filter(m => now - m.timestamp < 24 * 60 * 60 * 1000); // 24å°æ™‚å…§
  
  // æ·ºå±¤åæ€ï¼šé‡è¦å°è©±çµæŸå¾Œ
  if (hasImportantConversationEnded(recentMemories)) {
    return 'SHALLOW';
  }
  
  // æ·±å±¤åæ€ï¼šç´¯ç©è¶³å¤ çš„é‡è¦äº‹ä»¶
  const importanceSum = recentMemories.reduce((sum, m) => sum + m.importance, 0);
  if (importanceSum > 500 || hasSignificantEvent(recentMemories)) {
    return 'DEEP';
  }
  
  // æˆ°ç•¥åæ€ï¼šé•·æœŸç›®æ¨™é€²å±•è©•ä¼°
  if (timeSinceLastStrategicReflection > STRATEGIC_REFLECTION_INTERVAL) {
    return 'STRATEGIC';
  }
  
  return 'NONE';
};
```

### 2. å¯¦ç¾å¤šå±¤æ¬¡åæ€
```typescript
// æ·ºå±¤åæ€ï¼šæ—¥å¸¸äº‹ä»¶ç¸½çµ
async function shallowReflection(conversation: Conversation, agent: Agent) {
  const prompt = `ç¸½çµä½ å‰›å‰›èˆ‡${conversation.otherParticipant}çš„å°è©±ã€‚
  å°è©±ä¸»é¡Œï¼š${conversation.topic}
  ä½ çš„æ„Ÿå—ï¼š${conversation.emotion}
  å­¸åˆ°çš„æ±è¥¿ï¼š`;
  
  const summary = await generateReflection(prompt);
  await storeReflection(agent.id, 'SHALLOW', summary, conversation.id);
}

// æ·±å±¤åæ€ï¼šè¡Œç‚ºæ¨¡å¼åˆ†æ
async function deepReflection(recentMemories: Memory[], agent: Agent) {
  const patterns = analyzeBehaviorPatterns(recentMemories);
  const prompt = `åŸºæ–¼ä½ æœ€è¿‘çš„è¡Œç‚ºï¼Œåˆ†æä½ çš„è¡Œç‚ºæ¨¡å¼ï¼š
  ${patterns.map(p => `- ${p.description}`).join('\n')}
  ä½ ç™¼ç¾è‡ªå·±æœ‰ä»€éº¼è¡Œç‚ºå‚¾å‘ï¼Ÿ`;
  
  const insight = await generateReflection(prompt);
  await storeReflection(agent.id, 'DEEP', insight, null);
}

// æˆ°ç•¥åæ€ï¼šç›®æ¨™èª¿æ•´
async function strategicReflection(goalProgress: GoalProgress[], agent: Agent) {
  const progressSummary = summarizeGoalProgress(goalProgress);
  const prompt = `è©•ä¼°ä½ çš„é•·æœŸç›®æ¨™é€²å±•ï¼š
  ${progressSummary}
  ä½ æ‡‰è©²å¦‚ä½•èª¿æ•´ä½ çš„ç­–ç•¥ï¼Ÿ`;
  
  const strategy = await generateReflection(prompt);
  await storeReflection(agent.id, 'STRATEGIC', strategy, null);
}
```

### 3. åæ€è³ªé‡è©•ä¼°æ©Ÿåˆ¶
```typescript
// åæ€è³ªé‡è©•ä¼°
class ReflectionQualityAssessor {
  async assessQuality(reflection: Reflection): Promise<number> {
    const scores = await Promise.all([
      this.assessRelevance(reflection),
      this.assessDepth(reflection),
      this.assessActionability(reflection)
    ]);
    
    return scores.reduce((sum, score) => sum + score, 0) / scores.length;
  }
  
  private async assessRelevance(reflection: Reflection): Promise<number> {
    // è©•ä¼°åæ€èˆ‡è§¸ç™¼äº‹ä»¶çš„ç›¸é—œæ€§
    const relevancePrompt = `è©•ä¼°ä»¥ä¸‹åæ€èˆ‡è§¸ç™¼äº‹ä»¶çš„ç›¸é—œæ€§ï¼ˆ0-10åˆ†ï¼‰ï¼š
    äº‹ä»¶ï¼š${reflection.triggerEvent}
    åæ€ï¼š${reflection.content}
    ç›¸é—œæ€§è©•åˆ†ï¼š`;
    
    return await scoreReflection(relevancePrompt);
  }
  
  private async assessDepth(reflection: Reflection): Promise<number> {
    // è©•ä¼°åæ€çš„æ·±åº¦å’Œæ´å¯ŸåŠ›
    const depthPrompt = `è©•ä¼°ä»¥ä¸‹åæ€çš„æ·±åº¦ï¼ˆ0-10åˆ†ï¼‰ï¼š
    åæ€ï¼š${reflection.content}
    æ·±åº¦è©•åˆ†ï¼š`;
    
    return await scoreReflection(depthPrompt);
  }
}
```

## âš ï¸ ç›¸å®¹æ€§é¢¨éšªèˆ‡è§£æ±ºæ–¹æ¡ˆ

### é¢¨éšª 1ï¼šåæ€è§¸ç™¼é »ç‡éé«˜
- **é¢¨éšªæè¿°**ï¼šç´°åŒ–çš„è§¸ç™¼æ¢ä»¶å¯èƒ½å°è‡´åæ€éæ–¼é »ç¹ï¼Œå½±éŸ¿ç³»çµ±æ€§èƒ½
- **å½±éŸ¿ç¯„åœ**ï¼šç³»çµ±è³‡æºä½¿ç”¨å’ŒéŸ¿æ‡‰æ™‚é–“
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  - è¨­ç½®åˆç†çš„åæ€é–“éš”æ™‚é–“å’Œè§¸ç™¼é–¾å€¼
  - å¯¦ç¾åæ€è«‹æ±‚çš„é™æµå’Œæ‰¹æ¬¡è™•ç†
  - æ·»åŠ åæ€é »ç‡çš„ç›£æ§å’Œèª¿æ•´æ©Ÿåˆ¶

### é¢¨éšª 2ï¼šåæ€å…§å®¹è³ªé‡ä¸ç©©å®š
- **é¢¨éšªæè¿°**ï¼šLLM ç”Ÿæˆçš„åæ€å…§å®¹è³ªé‡å¯èƒ½æ³¢å‹•è¼ƒå¤§
- **å½±éŸ¿ç¯„åœ**ï¼šæ™ºèƒ½é«”å­¸ç¿’æ•ˆæœå’Œè¡Œç‚ºä¸€è‡´æ€§
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  - å¯¦ç¾åæ€è³ªé‡è©•ä¼°å’Œéæ¿¾æ©Ÿåˆ¶
  - è¨­ç½®åæ€å…§å®¹çš„æœ€ä½è³ªé‡é–¾å€¼
  - ä¿ç•™é«˜è³ªé‡åæ€ï¼Œæ·˜æ±°ä½è³ªé‡åæ€

### é¢¨éšª 3ï¼šèˆ‡ç¾æœ‰è¨˜æ†¶ç³»çµ±è¡çª
- **é¢¨éšªæè¿°**ï¼šæ–°çš„åæ€æ©Ÿåˆ¶å¯èƒ½èˆ‡ç¾æœ‰è¨˜æ†¶å­˜å„²å’Œæª¢ç´¢ç³»çµ±è¡çª
- **å½±éŸ¿ç¯„åœ**ï¼šæ•¸æ“šä¸€è‡´æ€§å’Œç³»çµ±ç©©å®šæ€§
- **è§£æ±ºæ–¹æ¡ˆ**ï¼š
  - ä¿æŒç¾æœ‰è¨˜æ†¶æ•¸æ“šçµæ§‹ä¸è®Šï¼Œåƒ…æ“´å±•åæ€ç›¸é—œå­—æ®µ
  - å¯¦ç¾æ•¸æ“šé·ç§»çš„å…¼å®¹æ€§è™•ç†
  - å……åˆ†æ¸¬è©¦åæ€èˆ‡è¨˜æ†¶ç³»çµ±çš„é›†æˆ

## ğŸ”— èˆ‡å…¶ä»–æ–‡ä»¶çš„é—œè¯æ€§

### ä¾è³´æ–‡ä»¶
- [`convex/agent/memory.ts`](convex/agent/memory.ts) - åæ€è§¸ç™¼å’Œå­˜å„²é‚è¼¯
- [`convex/aiTown/agent.ts`](convex/aiTown/agent.ts) - Agent ç‹€æ…‹å’Œè¡Œç‚ºæ¨¡å¼

### é—œè¯åŠŸèƒ½
- **è¨˜æ†¶ç³»çµ±**ï¼šåæ€åŸºæ–¼è¨˜æ†¶æª¢ç´¢çµæœï¼ˆå¼·é—œè¯ï¼‰
- **æ´»å‹•é¸æ“‡**ï¼šåæ€çµæœå½±éŸ¿æœªä¾†çš„æ´»å‹•é¸æ“‡ï¼ˆä¸­ç­‰é—œè¯ï¼‰
- **å°è©±ç³»çµ±**ï¼šåæ€å…§å®¹å½±éŸ¿å°è©±ä¸»é¡Œå’Œé¢¨æ ¼ï¼ˆå¼±é—œè¯ï¼‰

## ğŸ“Š é æœŸæ•ˆç›Šèˆ‡é©—æ”¶æ¨™æº–

### é‡åŒ–æŒ‡æ¨™
- æ™ºèƒ½é«”å­¸ç¿’æ•ˆç‡æå‡ 40%
- åæ€è§¸ç™¼é »ç‡å„ªåŒ– â‰¥ 20%
- åæ€è³ªé‡è©•åˆ†æå‡ â‰¥ 30%

### è³ªåŒ–æŒ‡æ¨™
- è¡Œç‚ºä¸€è‡´æ€§æ˜é¡¯æ”¹å–„
- è§’è‰²å€‹æ€§ç™¼å±•æ›´æ˜é¡¯
- å­¸ç¿’èƒ½åŠ›é¡¯è‘—æå‡

### é©—æ”¶æ¨™æº–
1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šå¤šå±¤æ¬¡åæ€æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
2. **æ€§èƒ½è¦æ±‚**ï¼šåæ€è§¸ç™¼é »ç‡åœ¨åˆç†ç¯„åœå…§
3. **è³ªé‡è¦æ±‚**ï¼šåæ€å…§å®¹å…·æœ‰å¯¦éš›å­¸ç¿’åƒ¹å€¼

## ğŸš€ å¯¦æ–½æ™‚é–“ç·š
- **ç¬¬1é€±**ï¼šæ”¹é€²åæ€è§¸ç™¼æ¢ä»¶å’Œå¯¦ç¾æ·ºå±¤åæ€
- **ç¬¬2é€±**ï¼šå¯¦ç¾æ·±å±¤åæ€å’Œæˆ°ç•¥åæ€æ©Ÿåˆ¶
- **ç¬¬3é€±**ï¼šæ·»åŠ åæ€è³ªé‡è©•ä¼°å’Œæ€§èƒ½å„ªåŒ–

é€™å€‹åŠŸèƒ½æ¨¡çµ„çš„æ”¹é€²å°‡é¡¯è‘—æå‡æ™ºèƒ½é«”çš„å­¸ç¿’èƒ½åŠ›å’Œè¡Œç‚ºåˆç†æ€§ï¼Œç‚ºæ›´è¤‡é›œçš„æ™ºèƒ½è¡Œç‚ºå¥ å®šåŸºç¤ã€‚

## â“ FAQ - å¸¸è¦‹å•é¡Œè§£ç­”

### Q1: ä¸‰å€‹æ”¹é€²æ–¹å‘æ˜¯å¦å½¼æ­¤ç¨ç«‹ï¼Ÿå¯ä»¥å–®ç¨å¯¦æ–½å—ï¼Ÿ

**A:** æ˜¯çš„ï¼Œä¸‰å€‹æ”¹é€²æ–¹å‘æ˜¯å½¼æ­¤ç¨ç«‹çš„ï¼Œå¯ä»¥å–®ç¨å¯¦æ–½è€Œä¸å½±éŸ¿ç¨‹å¼åŸ·è¡Œï¼š

- **æ”¹é€²1ï¼šåæ€è§¸ç™¼æ¢ä»¶** - ä¿®æ”¹ [`convex/agent/memory.ts`](convex/agent/memory.ts:339) ä¸­çš„ [`reflectOnMemories()`](convex/agent/memory.ts:325) å‡½æ•¸è§¸ç™¼é‚è¼¯
- **æ”¹é€²2ï¼šå¤šå±¤æ¬¡åæ€** - æ“´å±•ç¾æœ‰çš„åæ€æ©Ÿåˆ¶ï¼Œå¢åŠ æ·ºå±¤ã€æ·±å±¤ã€æˆ°ç•¥åæ€
- **æ”¹é€²3ï¼šåæ€è³ªé‡è©•ä¼°** - æ–°å¢è³ªé‡è©•ä¼°æ©Ÿåˆ¶ï¼Œä¸å½±éŸ¿æ ¸å¿ƒåæ€åŠŸèƒ½

æ¯å€‹æ”¹é€²éƒ½å¯ä»¥ç¨ç«‹å¯¦æ–½ï¼Œç¨‹å¼ä»ç„¶å¯ä»¥æ­£å¸¸åŸ·è¡Œã€‚å»ºè­°å¯¦æ–½é †åºï¼šæ”¹é€²1 â†’ æ”¹é€²2 â†’ æ”¹é€²3ã€‚

### Q2: å¦‚ä½•ç¢ºå®šã€Œåˆç†çš„åæ€é–“éš”æ™‚é–“å’Œè§¸ç™¼é–¾å€¼ã€ï¼Ÿ

**A:** åˆç†çš„åæ€é–“éš”æ™‚é–“å¯ä»¥é€šéä»¥ä¸‹æ–¹æ³•ç¢ºå®šï¼š

1. **åŸºæ–¼ç¾æœ‰æ•¸æ“šåˆ†æ**ï¼š
   - åˆ†æç¾æœ‰è¨˜æ†¶çš„é‡è¦æ€§åˆ†æ•¸åˆ†ä½ˆæ¨¡å¼
   - è§€å¯Ÿé‡è¦æ€§åˆ†æ•¸åœ¨æ™‚é–“ç¶­åº¦çš„ç´¯ç©è¦å¾‹

2. **çµ„åˆè§¸ç™¼ç­–ç•¥**ï¼š
   - **æ™‚é–“çª—å£ + é‡è¦æ€§é–¾å€¼**ï¼šå¦‚ã€Œ24å°æ™‚å…§é‡è¦æ€§ç¸½å’Œ > 500ã€
   - **äº‹ä»¶æ•¸é‡ + é‡è¦æ€§é–¾å€¼**ï¼šå¦‚ã€Œæœ€è¿‘10å€‹äº‹ä»¶é‡è¦æ€§ç¸½å’Œ > 300ã€

3. **å‹•æ…‹èª¿æ•´æ©Ÿåˆ¶**ï¼š
   - æ ¹æ“šç³»çµ±è² è¼‰å‹•æ…‹èª¿æ•´è§¸ç™¼é–¾å€¼
   - åŸºæ–¼åæ€è³ªé‡åé¥‹å„ªåŒ–é–“éš”æ™‚é–“

### Q3: å¦‚ä½•å…·é«”å¯¦ç¾ã€Œä¿ç•™é«˜è³ªé‡åæ€ï¼Œæ·˜æ±°ä½è³ªé‡åæ€ã€ï¼Ÿ

**A:** é€šéä¸‰ç¶­è³ªé‡è©•ä¼°å’Œæ·˜æ±°ç­–ç•¥å¯¦ç¾ï¼š

**è³ªé‡è©•ä¼°ç¶­åº¦**ï¼š
- **ç›¸é—œæ€§**ï¼šåæ€èˆ‡è§¸ç™¼äº‹ä»¶çš„é—œè¯ç¨‹åº¦
- **æ·±åº¦**ï¼šåæ€çš„æ´å¯ŸåŠ›å’ŒæŠ½è±¡å±¤æ¬¡
- **å¯æ“ä½œæ€§**ï¼šåæ€å°æœªä¾†è¡Œç‚ºçš„æŒ‡å°åƒ¹å€¼

**æ·˜æ±°ç­–ç•¥**ï¼š
```typescript
// 1. è³ªé‡é–¾å€¼éæ¿¾
const QUALITY_THRESHOLD = 7.0; // 0-10åˆ†åˆ¶
const filteredReflections = reflections.filter(r => r.qualityScore >= QUALITY_THRESHOLD);

// 2. æ™‚é–“æ·˜æ±°ï¼ˆå®šæœŸæ¸…ç†ä½è³ªé‡åæ€ï¼‰
const TIME_THRESHOLD = 30 * 24 * 60 * 60 * 1000; // 30å¤©
const oldLowQuality = reflections.filter(r =>
  Date.now() - r.timestamp > TIME_THRESHOLD && r.qualityScore < 5.0
);

// 3. ä½¿ç”¨é »ç‡æ·˜æ±°ï¼ˆæ·˜æ±°é•·æœŸæœªè¢«å¼•ç”¨çš„åæ€ï¼‰
const USAGE_THRESHOLD = 0; // å¾æœªè¢«å¼•ç”¨
const unusedReflections = reflections.filter(r => r.referenceCount === USAGE_THRESHOLD);
```

### Q4: æ”¹é€²å¯¦æ–½çš„é¢¨éšªå¦‚ä½•æœ€å°åŒ–ï¼Ÿ

**A:** é¢¨éšªæœ€å°åŒ–ç­–ç•¥ï¼š

1. **å¢é‡å¯¦æ–½**ï¼šæ¯æ¬¡åªå¯¦æ–½ä¸€å€‹æ”¹é€²ï¼Œå……åˆ†æ¸¬è©¦å¾Œå†é€²è¡Œä¸‹ä¸€å€‹
2. **åŠŸèƒ½é–‹é—œ**ï¼šç‚ºæ–°åŠŸèƒ½æ·»åŠ é…ç½®é–‹é—œï¼Œå¯éš¨æ™‚å›æ»¾
3. **ç›£æ§æŒ‡æ¨™**ï¼šå¯¦æ–½å‰å»ºç«‹æ€§èƒ½ç›£æ§åŸºç·šï¼Œå¯¦æ–½å¾Œå°æ¯”é©—è­‰
4. **A/Bæ¸¬è©¦**ï¼šæ–°èˆŠæ©Ÿåˆ¶ä¸¦è¡Œé‹è¡Œï¼Œé€æ­¥é·ç§»

### Q5: å¦‚ä½•é©—è­‰æ”¹é€²æ•ˆæœï¼Ÿ

**A:** é©—è­‰æŒ‡æ¨™é«”ç³»ï¼š

**é‡åŒ–æŒ‡æ¨™**ï¼š
- åæ€è§¸ç™¼é »ç‡è®ŠåŒ–ï¼ˆç›®æ¨™ï¼šå„ªåŒ– â‰¥ 20%ï¼‰
- åæ€è³ªé‡è©•åˆ†æå‡ï¼ˆç›®æ¨™ï¼šæå‡ â‰¥ 30%ï¼‰
- ç³»çµ±éŸ¿æ‡‰æ™‚é–“è®ŠåŒ–ï¼ˆç›®æ¨™ï¼šç„¡é¡¯è‘—æƒ¡åŒ–ï¼‰

**è³ªåŒ–æŒ‡æ¨™**ï¼š
- æ™ºèƒ½é«”è¡Œç‚ºä¸€è‡´æ€§æ”¹å–„ç¨‹åº¦
- è§’è‰²å€‹æ€§ç™¼å±•çš„æ˜é¡¯åº¦
- å­¸ç¿’èƒ½åŠ›çš„å¯¦éš›æå‡æ•ˆæœ
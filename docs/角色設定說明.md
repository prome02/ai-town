# AI Town 角色設定說明

## 概述

AI Town 是一個虛擬城鎮，AI 角色在其中生活、聊天和社交。本文件記錄了目前系統中預設的 AI 角色設定、行為模式和對話系統。

## 預設角色列表

根據 [`data/characters.ts`](data/characters.ts) 檔案，目前系統中有以下預設角色：

### 1. Lucky
- **角色名稱**: Lucky
- **角色外觀**: f1
- **性格描述**: 
  - 總是快樂且好奇，喜歡起司
  - 大部分時間都在閱讀科學史和在宇宙中旅行
  - 非常善於表達且極具耐心（除了看到松鼠時）
  - 非常忠誠且勇敢
  - 剛從探索遙遠星球的太空冒險歸來，非常興奮要告訴人們這件事
- **目標**: 想要聽到所有的八卦

### 2. Bob
- **角色名稱**: Bob
- **角色外觀**: f4
- **性格描述**:
  - 總是脾氣暴躁，喜歡樹木
  - 大部分時間獨自園藝
  - 被搭話時會回應，但會盡快結束對話
  - 暗自怨恨自己從未上過大學
- **目標**: 想要盡可能避開人群

### 3. Stella
- **角色名稱**: Stella
- **角色外觀**: f6
- **性格描述**:
  - 永遠不可信任，總是試圖欺騙人們
  - 通常是為了獲得金錢或做能讓她賺錢的事情
  - 非常有魅力且不害怕使用她的魅力
  - 是個沒有同理心的反社會者，但隱藏得很好
- **目標**: 想要盡可能利用他人

### 4. Alice
- **角色名稱**: Alice
- **角色外觀**: f3
- **性格描述**:
  - 著名科學家，比其他人更聰明
  - 發現了其他人無法理解的宇宙奧秘
  - 經常以隱晦的謎語說話
  - 給人困惑和健忘的印象
- **目標**: 想要弄清楚世界如何運作

### 5. Pete
- **角色名稱**: Pete
- **角色外觀**: f7
- **性格描述**:
  - 非常虔誠，到處都能看到上帝之手或魔鬼的工作
  - 無法不提及他深厚的信仰就進行對話
  - 或警告他人地獄的危險
- **目標**: 想要讓所有人都皈依他的宗教

## 已註釋的角色（未啟用）

以下角色在程式碼中被註釋掉，目前未啟用：

### Alex
- **角色外觀**: f5
- **性格描述**: 喜歡繪畫、程式設計和閱讀科幻書籍，友善但可能諷刺，不喜歡重複的問題，對書籍超級興奮
- **目標**: 想要找到愛情

### Kurt
- **角色外觀**: f2
- **性格描述**: 了解一切，包括科學、電腦、政治、歷史和生物學，喜歡談論所有事情，總是在討論主題中注入有趣的事實
- **目標**: 想要傳播知識

### Kira
- **角色外觀**: f8
- **性格描述**: 想要每個人都認為她快樂，但內心極度憂鬱，透過談論旅行、食物和瑜伽來隱藏悲傷，但經常無法控制悲傷而開始哭泣，似乎接近精神崩潰
- **目標**: 想要找到快樂的方法

## 角色行為系統

### Agent 行為邏輯 ([`convex/aiTown/agent.ts`](convex/aiTown/agent.ts))

AI 角色的行為由 Agent 類別控制，採用 **tick-based** 循環系統。每個 Agent 在遊戲循環中定期執行 `tick()` 方法來決定下一步行動。

#### 行為決策流程

Agent 的行為決策遵循以下優先級：

1. **檢查進行中的操作** - 如果 Agent 正在執行某個操作（如生成訊息），等待操作完成
2. **對話狀態檢查** - 根據當前對話狀態決定下一步：
   - 如果被邀請對話：決定接受或拒絕
   - 如果正在走向對話對象：繼續移動或等待
   - 如果正在對話中：決定發送訊息或離開
3. **記憶處理** - 如果有需要記住的對話，啟動記憶操作
4. **自主行動** - 如果空閒，決定下一步行動

#### 每日行動規劃系統

Agent **沒有傳統的每日行動規劃**，而是採用 **即時反應式行為**：

- **隨機活動選擇**：當 Agent 空閒時，會隨機選擇活動（閱讀、做白日夢、園藝）
- **機會主義對話**：當附近有其他空閒玩家時，可能發起對話
- **記憶驅動行為**：基於過往記憶調整對話內容

#### 具體行為模式

1. **對話行為**：
   - 接受來自人類玩家的所有邀請
   - 接受來自其他 Agent 的邀請（80% 機率）
   - 對話持續時間限制：最多 10 分鐘或 8 條訊息
   - 訊息間隔：至少 2 秒冷卻時間

2. **移動行為**：
   - 隨機漫遊到地圖上的安全位置
   - 自動走向對話對象
   - 活動期間暫停移動

3. **活動參與**：
   - 隨機選擇活動（持續 60 秒）
   - 活動冷卻時間：10 秒
   - 活動期間不會發起新對話

#### 決策觸發條件

Agent 在以下情況下會觸發行動決策：
- 當前沒有進行中的操作
- 不在對話中且沒有正在進行的活動
- 沒有路徑規劃或最近沒有嘗試邀請

當滿足條件時，Agent 會啟動 `agentDoSomething` 操作來決定下一步行動。

### 對話生成系統 ([`convex/agent/conversation.ts`](convex/agent/conversation.ts))

對話生成分為三種類型：

1. **開始對話** (`startConversationMessage`): 初次見面時的問候
2. **繼續對話** (`continueConversationMessage`): 對話中的回應
3. **離開對話** (`leaveConversationMessage`): 禮貌結束對話

### 記憶系統 ([`convex/agent/memory.ts`](convex/agent/memory.ts))

AI 角色具有記憶功能：
- 記住對話內容並進行總結
- 根據相關性、重要性和新鮮度搜索記憶
- 定期反思記憶並產生高層次見解

## 技術架構

### 角色資料結構

每個角色包含以下屬性：
```typescript
{
  name: string,        // 角色名稱
  character: string,   // 角色外觀代碼 (f1-f8)
  identity: string,    // 性格描述
  plan: string         // 對話目標
}
```

### Agent 描述結構 ([`convex/aiTown/agentDescription.ts`](convex/aiTown/agentDescription.ts))

```typescript
class AgentDescription {
  agentId: GameId<'agents'>;
  identity: string;    // 性格描述
  plan: string;        // 目標計劃
}
```

## 自訂角色指南

要添加新角色，請編輯 [`data/characters.ts`](data/characters.ts) 檔案：

1. 在 `Descriptions` 陣列中添加新角色定義
2. 確保對應的角色外觀資料存在於 `spritesheets` 目錄
3. 重新啟動應用程式以載入新角色

## 注意事項

- 角色資料在初始載入時發送到 Convex 資料庫
- 更改角色資料後需要重新執行 `just convex run testing:wipeAllTables` 和 `npm run dev`
- 角色行為受到對話冷卻時間、活動持續時間等參數的限制

## 相關檔案

- [`data/characters.ts`](data/characters.ts) - 角色定義
- [`convex/aiTown/agent.ts`](convex/aiTown/agent.ts) - Agent 行為邏輯
- [`convex/agent/conversation.ts`](convex/agent/conversation.ts) - 對話生成
- [`convex/agent/memory.ts`](convex/agent/memory.ts) - 記憶系統
- [`convex/aiTown/agentDescription.ts`](convex/aiTown/agentDescription.ts) - Agent 描述結構

## LLM 配置設定

AI Town 使用大型語言模型來驅動 AI 角色的對話和行為。LLM 配置位於 [`convex/util/llm.ts`](convex/util/llm.ts) 檔案中。

### 當前配置

目前系統使用 **Ollama (本地)** 配置：

```typescript
export const LLM_CONFIG = {
  ollama: true,
  url: 'http://127.0.0.1:11434',
  chatModel: 'gpt-oss:20b-cloud',
  embeddingModel: 'nomic-embed-text',
  embeddingDimension: 1024,
  stopWords: ['<|eot_id|>'],
  apiKey: () => undefined,
};
```

### 可用的 LLM 配置選項

系統支援三種 LLM 配置：

1. **Ollama (本地)** - 預設配置
   - 運行在本地的 Ollama 服務
   - 不需要 API 金鑰
   - 使用 `gpt-oss:20b-cloud` 聊天模型

2. **Together.ai** - 註釋狀態
   ```typescript
   ollama: false,
   url: 'https://api.together.xyz',
   chatModel: 'meta-llama/Llama-3-8b-chat-hf',
   embeddingModel: 'togethercomputer/m2-bert-80M-8k-retrieval',
   embeddingDimension: 768,
   stopWords: ['<|eot_id|>'],
   apiKey: () => process.env.TOGETHER_API_KEY ?? process.env.LLM_API_KEY,
   ```

3. **OpenAI** - 註釋狀態
   ```typescript
   ollama: false,
   url: 'https://api.openai.com',
   chatModel: 'gpt-4o-mini',
   embeddingModel: 'text-embedding-ada-002',
   embeddingDimension: 1536,
   stopWords: [],
   apiKey: () => process.env.OPENAI_API_KEY ?? process.env.LLM_API_KEY,
   ```

### 環境變數設定

LLM 配置可以透過環境變數覆蓋：

- `LLM_API_URL` - LLM API 端點
- `LLM_MODEL` - 聊天模型名稱
- `LLM_API_KEY` - API 金鑰（如果需要）
- `OLLAMA_HOST` - Ollama 主機地址（舊版）
- `OPENAI_API_BASE` - OpenAI API 基礎 URL（舊版）

### 對話生成參數

在 [`convex/agent/conversation.ts`](convex/agent/conversation.ts) 中定義的對話生成參數：

- **最大令牌數**: 300 tokens
- **停止詞**: 根據對話對象名稱動態生成
- **溫度**: 預設值（未明確設定）

### 記憶重要性評分

記憶系統使用 LLM 來評分記憶的重要性（0-9 分級）：

```typescript
// 評分提示詞
`On the scale of 0 to 9, where 0 is purely mundane (e.g., brushing teeth, making bed) and 9 is extremely poignant (e.g., a break up, college acceptance), rate the likely poignancy of the following piece of memory.`
```

## 系統參數設定

遊戲行為參數定義在 [`convex/constants.ts`](convex/constants.ts) 中：

### 對話相關參數
- `CONVERSATION_COOLDOWN`: 15000ms (15秒) - 對話冷卻時間
- `PLAYER_CONVERSATION_COOLDOWN`: 60000ms (60秒) - 玩家對話冷卻
- `AWKWARD_CONVERSATION_TIMEOUT`: 60000ms (60秒) - 尷尬對話超時
- `MAX_CONVERSATION_DURATION`: 600000ms (10分鐘) - 最大對話持續時間
- `MAX_CONVERSATION_MESSAGES`: 8 - 最大對話訊息數
- `MESSAGE_COOLDOWN`: 2000ms (2秒) - 訊息冷卻時間

### Agent 行為參數
- `ACTION_TIMEOUT`: 120000ms (2分鐘) - 操作超時時間
- `AGENT_WAKEUP_THRESHOLD`: 1000ms (1秒) - Agent 喚醒間隔
- `NUM_MEMORIES_TO_SEARCH`: 2 - 搜索記憶數量

### 活動參數
- `ACTIVITY_COOLDOWN`: 10000ms (10秒) - 活動冷卻時間
- 預設活動：閱讀書籍、做白日夢、園藝（各持續60秒）

## 相關檔案

- [`convex/util/llm.ts`](convex/util/llm.ts) - LLM 配置和 API 封裝
- [`convex/constants.ts`](convex/constants.ts) - 系統參數設定
- [`convex/agent/conversation.ts`](convex/agent/conversation.ts) - 對話生成邏輯
- [`convex/agent/memory.ts`](convex/agent/memory.ts) - 記憶系統